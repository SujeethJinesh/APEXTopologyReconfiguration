# Milestone M2 — Integrations (FS/Test adapters + HTTP LLM client)

**What:** Provide concrete adapters for filesystem and test execution (MCP), and a minimal HTTP LLM client.
- LocalFS: whitelist-enforced read/write/patch/search (content regex) with symlink traversal protection
- PytestAdapter: `pytest` discovery and execution via async subprocess with timeout and proper process cleanup
- HTTPLLM: simple POST `/generate`, request timeout, retry on 5xx only (not 4xx)

**How:**
- Async wrappers around file I/O via `asyncio.to_thread`
- Path validation ensures resolved targets stay within whitelist root
- Subprocess execution with proper zombie prevention on timeout
- aiohttp client with context-managed session + selective retry logic

**Why:** Enables agents to use tools (FS/Test) and an LLM endpoint in dev (Ollama) while keeping MVP simple and secure.

**Code Locations:**
- `apex/integrations/mcp/fs_local.py` - LocalFS implementation
- `apex/integrations/mcp/test_runner.py` - PytestAdapter implementation  
- `apex/integrations/llm/llm_http.py` - HTTPLLM client implementation

**Tests:**
- `tests/test_fs_local_whitelist_patch_search.py` - FS security & functionality tests
- `tests/test_pytest_adapter_discover_run.py` - Test adapter verification
- `tests/test_llm_http_client.py` - LLM client retry & timeout tests

**Commands to reproduce:**
- `pip install -e ".[dev]"`
- `make lint`
- `make test`

**Results:**
- 23 tests pass (including symlink escape & 4xx no-retry tests)
- Lint checks pass (ruff + black)
- CI remains green

**Security Fixes (from code review):**
- Fixed critical symlink traversal vulnerability in `search_files()`
- Added `followlinks=False` and path validation to prevent whitelist escape
- Test coverage for symlink escape attempts

**Reliability Improvements:**
- PytestAdapter properly reaps child processes on timeout (prevents zombies)
- HTTPLLM only retries on 5xx errors per spec (4xx errors fail immediately)
- Deterministic sorting of search results

**DoD:** ✅ Complete
- All tests pass including security tests
- Path whitelist enforced with symlink protection
- Process cleanup prevents zombies
- Retry logic matches specification
- CI green