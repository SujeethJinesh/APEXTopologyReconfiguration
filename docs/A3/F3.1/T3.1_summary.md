# T3.1 Summary: Scripted Role Agents

## What

Implemented minimal, deterministic scripted agents for the APEX framework:
- **BaseAgent** (`apex/agents/base.py`): Abstract base class providing core agent functionality
- **PlannerAgent** (`apex/agents/roles/planner.py`): Orchestrates workflow, acts as hub in star topology
- **CoderAgent** (`apex/agents/roles/coder.py`): Reads and patches code files
- **RunnerAgent** (`apex/agents/roles/runner.py`): Discovers and executes tests
- **CriticAgent** (`apex/agents/roles/critic.py`): Evaluates test results and provides feedback
- **SummarizerAgent** (`apex/agents/roles/summarizer.py`): Creates final summary reports

## How

### Architecture
- Agents inherit from `BaseAgent` which provides:
  - Constructor accepting `agent_id`, `router`, `switch`, `fs`, `test`, `llm`
  - Abstract `handle()` method to process messages
  - `_new_msg()` utility for creating messages with proper epoch stamping

### Topology Awareness
Each agent checks `switch.active()` to determine current topology and adjusts routing:
- **Star**: All non-planner agents route through Planner hub
- **Chain**: Follow strict pipeline order
- **Flat**: Direct peer-to-peer communication allowed

### Deterministic Behavior
- **No real LLM dependency**: Uses `StubLLM` returning fixed responses
- **Fixed bug pattern**: Always patches `a - b` to `a + b` in test file
- **Reproducible results**: Tests pass deterministically after patch

## Why

### Design Decisions

1. **Topology-aware routing in agents**: Agents adapt their routing based on active topology, allowing same agent code to work across different topologies.

2. **Planner as hub in star**: In star topology, Planner forwards messages using `next_agent` hints, maintaining star semantics while reusing agent logic.

3. **Deterministic stubs**: Ensures reproducible tests and eliminates external dependencies (network, LLM APIs).

4. **Episode runner separation**: `EpisodeRunner` orchestrates without bypassing Router, maintaining proper message flow invariants.

## Implementation Details

### Files Created
- `apex/agents/__init__.py`: Package initialization
- `apex/agents/base.py`: BaseAgent class (lines 1-56)
- `apex/agents/roles/*.py`: Role implementations (5 files)
- `apex/agents/episode.py`: Episode orchestration (lines 1-113)

### Epoch Stamping
- **Note**: `ISwitchEngine.ingress_epoch()` not found in codebase
- **Fallback used**: `switch.active()[1]` for epoch stamping (line 48 in `base.py`)

### LLM Stub
```python
class StubLLM:
    async def generate(self, prompt: str, max_tokens: int) -> dict:
        return {
            "text": "Fix the bug in the add function by changing subtraction to addition.",
            "tokens_used": 15,
        }
```

## Test Commands

```bash
pip install -e ".[dev]"
pytest -q tests/test_agents_star_end_to_end.py
pytest -q tests/test_agents_chain_end_to_end.py
pytest -q tests/test_agents_flat_end_to_end.py
pytest -q tests/test_agents_switch_mid_episode.py
```

## Sample JSONL Traces

### Star Topology (`docs/A3/artifacts/agents_star_trace.jsonl`)
```json
{"step": 1, "event": "enqueue", "epoch": 1, "topology": "star", "from_agent": "system", "to_agent": "planner", "msg_id": "80580473cdbe45ed85a0a099e20083ca"}
{"step": 3, "event": "handle", "epoch": 1, "topology": "star", "agent": "planner", "action": "kickoff"}
{"step": 6, "event": "handle", "epoch": 1, "topology": "star", "agent": "coder", "action": "process"}
```

### Chain Topology (`docs/A3/artifacts/agents_chain_trace.jsonl`)
```json
{"step": 4, "event": "enqueue", "epoch": 1, "topology": "chain", "from_agent": "planner", "to_agent": "coder", "msg_id": "abc123"}
{"step": 7, "event": "enqueue", "epoch": 1, "topology": "chain", "from_agent": "coder", "to_agent": "runner", "msg_id": "def456"}
{"step": 10, "event": "enqueue", "epoch": 1, "topology": "chain", "from_agent": "runner", "to_agent": "critic", "msg_id": "ghi789"}
```

### Flat Topology (`docs/A3/artifacts/agents_flat_trace.jsonl`)
```json
{"step": 4, "event": "enqueue", "epoch": 1, "topology": "flat", "from_agent": "planner", "to_agent": "coder", "msg_id": "xyz111"}
{"step": 7, "event": "enqueue", "epoch": 1, "topology": "flat", "from_agent": "coder", "to_agent": "runner", "msg_id": "xyz222"}
{"step": 13, "event": "enqueue", "epoch": 1, "topology": "flat", "from_agent": "critic", "to_agent": "coder", "msg_id": "xyz333"}
```

## Artifact Paths
- `docs/A3/artifacts/agents_star_trace.jsonl` - Star topology execution trace
- `docs/A3/artifacts/agents_chain_trace.jsonl` - Chain topology execution trace  
- `docs/A3/artifacts/agents_flat_trace.jsonl` - Flat topology execution trace
- `docs/A3/artifacts/agents_switch_trace.jsonl` - Mid-episode switch trace (optional)