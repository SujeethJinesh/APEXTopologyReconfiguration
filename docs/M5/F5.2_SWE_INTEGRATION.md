# F5.2: SWE-bench Lite Integration

## Implementation Summary

This milestone completes the integration of SWE-bench Lite evaluation into the APEX Success@Budget harness.

## Key Changes

### 1. Removed NotImplementedError Block
- **File:** apex/eval/harness.py
- **Change:** Removed the NotImplementedError that was blocking SWE mode
- **Lines:** Previously line 72-74, now properly handles SWE mode initialization

### 2. SWE-bench Provider Implementation
- **File:** apex/eval/providers/swe_lite.py
- **Functionality:**
  - SWERecord dataclass with exact HF dataset field mapping
  - Offline mode support with local cache
  - Network gating with APEX_ALLOW_NETWORK
  - Proper parsing of FAIL_TO_PASS/PASS_TO_PASS fields

### 3. Repository Manager
- **File:** apex/eval/repo_manager.py
- **Features:**
  - Git repository preparation at specific commits
  - Patch application with -p0/-p1 fallback
  - Test execution with pytest
  - Result parsing and timeout handling

### 4. Harness SWE Mode Integration
- **File:** apex/eval/harness.py
- **Updates:**
  - Added SWE mode initialization with provider
  - Implemented _run_swe_episode() method
  - Task loading from SWE-bench datasets
  - Workspace cleanup after evaluation

### 5. CLI Updates
- **File:** scripts/run_eval_success_at_budget.py
- **New Flags:**
  - `--mode {stub,swe}`: Select evaluation mode
  - `--split {dev,test}`: Choose dataset split
  - `--limit N`: Limit number of tasks
  - `--offline`: Use local cache only
  - `--oracle-smoke`: Apply gold patches for validation

## Usage Examples

### 1. Stub Mode (Default, CI-safe)
```bash
python scripts/run_eval_success_at_budget.py \
  --policy static_star \
  --episodes 12 \
  --budget 10000 \
  --out results/stub_star.jsonl
```

### 2. SWE Mode with Network (Local)
```bash
APEX_ALLOW_NETWORK=1 python scripts/run_eval_success_at_budget.py \
  --mode swe \
  --split dev \
  --limit 5 \
  --policy static_star \
  --budget 10000 \
  --out results/swe_dev.jsonl
```

### 3. SWE Mode Offline (With Fixtures)
```bash
python scripts/run_eval_success_at_budget.py \
  --mode swe \
  --split dev \
  --offline \
  --policy static_star \
  --budget 10000 \
  --out results/swe_offline.jsonl
```

### 4. Oracle Smoke Validation
```bash
APEX_ALLOW_NETWORK=1 python scripts/run_eval_success_at_budget.py \
  --mode swe \
  --split dev \
  --limit 2 \
  --oracle-smoke \
  --policy static_star \
  --budget 50000 \
  --out results/oracle_smoke.jsonl
```

### 5. Generate Oracle Artifacts
```bash
APEX_ALLOW_NETWORK=1 python scripts/generate_oracle_smoke.py \
  --limit 2 \
  --split dev \
  --out docs/M5/artifacts/oracle_smoke.jsonl
```

## Testing

### Unit Tests (Offline, CI-safe)
```bash
# Test provider with fixtures
pytest tests/test_swe_provider.py -v

# Test repo manager
pytest tests/test_repo_manager.py -v

# Test harness SWE mode
pytest tests/test_harness_swe.py -v
```

### External Tests (Network Required)
```bash
# Run network tests
APEX_ALLOW_NETWORK=1 pytest tests/external/test_swe_network.py -v
```

## File Structure
```
apex/
  eval/
    providers/
      __init__.py         # Exports SWELiteProvider, SWERecord
      swe_lite.py         # SWE-bench Lite provider implementation
    harness.py            # Updated with SWE mode support
    repo_manager.py       # Git operations and test execution
scripts/
  run_eval_success_at_budget.py  # Updated CLI with all flags
  generate_oracle_smoke.py       # Oracle validation script
tests/
  fixtures/
    swe_bench_lite_dev.jsonl     # Sample tasks for offline testing
  external/
    test_swe_network.py          # Network-gated tests
  test_swe_provider.py           # Provider unit tests
  test_repo_manager.py           # RepoManager unit tests
  test_harness_swe.py            # Harness SWE mode tests
```

## Network Gating

All network access is gated by the `APEX_ALLOW_NETWORK` environment variable:

1. **Without APEX_ALLOW_NETWORK:**
   - SWE mode requires `--offline` flag
   - Uses local fixtures in tests/fixtures/
   - CI tests remain stable

2. **With APEX_ALLOW_NETWORK=1:**
   - Can download from Hugging Face
   - Can clone GitHub repositories
   - Enables oracle smoke validation

## Success@Budget Metric

The implementation correctly enforces Success@Budget:
- Task succeeds only if tests pass AND tokens ≤ budget
- Token usage simulated from test execution time
- Budget violations tracked separately

## Dataset Details

- **Dev Split:** 23 tasks (quick validation)
- **Test Split:** 300 tasks (full evaluation)
- **Dataset:** princeton-nlp/SWE-bench_Lite on Hugging Face

## Field Mappings

| HF Dataset Field | SWERecord Field |
|-----------------|-----------------|
| instance_id | task_id |
| repo | repo |
| base_commit | base_commit |
| environment_setup_commit | env_setup_commit |
| patch | patch |
| test_patch | test_patch |
| FAIL_TO_PASS | fail_to_pass |
| PASS_TO_PASS | pass_to_pass |
| problem_statement | problem_statement |
| hints_text | hints_text |

## Verification

The implementation has been verified to:
1. ✅ Remove NotImplementedError blocking SWE mode
2. ✅ Load real SWE-bench Lite tasks from HF
3. ✅ Apply patches with -p0/-p1 fallback
4. ✅ Run tests and parse results
5. ✅ Support offline mode with fixtures
6. ✅ Gate network access properly
7. ✅ Clean up workspaces after evaluation
8. ✅ Generate oracle smoke artifacts